name: ğŸš€ E-commerce CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_PREFIX: ecommerce

jobs:
  # é˜¶æ®µ1: éªŒè¯
  validate:
    name: âœ… é¡¹ç›®éªŒè¯
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: éªŒè¯é¡¹ç›®ç»“æ„
      run: |
        echo "=== ç”µå•†é¡¹ç›®éªŒè¯ ==="
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        
        # éªŒè¯æ ¸å¿ƒæ–‡ä»¶
        files=("docker-compose.yml" "frontend/Dockerfile" "backend/Dockerfile" "backend/pom.xml" "frontend/package.json")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰å¿…è¦æ–‡ä»¶å­˜åœ¨"
        
  # é˜¶æ®µ2: æ„å»º
  build:
    name: ğŸ—ï¸ é¡¹ç›®æ„å»º
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: æ„å»ºåç«¯
      run: |
        echo "æ„å»ºSpring Bootåç«¯..."
        cd backend
        mvn clean package -DskipTests
        echo "âœ… åç«¯æ„å»ºæˆåŠŸ"
        
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: æ„å»ºå‰ç«¯
      run: |
        echo "æ„å»ºVue.jså‰ç«¯..."
        cd frontend
        npm ci
        npm run build
        echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"
        
    - name: æ„å»ºDockeré•œåƒ
      run: |
        echo "æ„å»ºDockeré•œåƒ..."
        docker build -t $IMAGE_PREFIX-frontend:${{ github.sha }} ./frontend
        docker build -t $IMAGE_PREFIX-backend:${{ github.sha }} ./backend
        docker images | grep $IMAGE_PREFIX
        
  # é˜¶æ®µ3: æµ‹è¯•
  test:
    name: ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 5
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "è¿è¡ŒSpring Bootå•å…ƒæµ‹è¯•..."
        cd backend
        mvn test
        echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: backend/target/surefire-reports/
        retention-days: 7
        
    # é˜¶æ®µ4: é›†æˆæµ‹è¯•ï¼ˆæœåŠ¡åŠŸèƒ½éªŒè¯ï¼‰
  integration:
    name: ğŸ”— é›†æˆæµ‹è¯•ï¼ˆæœåŠ¡åŠŸèƒ½éªŒè¯ï¼‰
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ„å»ºæµ‹è¯•é•œåƒ
      run: |
        echo "=== æ„å»ºæµ‹è¯•é•œåƒ ==="
        docker build -t ecommerce-frontend-test ./frontend
        docker build -t ecommerce-backend-test ./backend
        
    - name: æµ‹è¯•æ•°æ®åº“æœåŠ¡åŠŸèƒ½
      run: |
        echo "=== æµ‹è¯•æ•°æ®åº“æœåŠ¡åŠŸèƒ½ ==="
        
        # å¯åŠ¨MySQLå®¹å™¨
        docker run -d --name test-mysql \
          -e MYSQL_ROOT_PASSWORD=root \
          -e MYSQL_DATABASE=ecommerce_test \
          -p 3306:3306 \
          mysql:8.0
        
        echo "ç­‰å¾…MySQLå¯åŠ¨..."
        sleep 35
        
        # æµ‹è¯•æ•°æ®åº“è¿æ¥å’ŒåŸºæœ¬åŠŸèƒ½
        echo "æµ‹è¯•æ•°æ®åº“è¿æ¥..."
        docker exec test-mysql mysql -uroot -proot -e "SHOW DATABASES;" && echo "âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ"
        
        echo "æµ‹è¯•æ•°æ®åº“CRUDæ“ä½œ..."
        docker exec test-mysql mysql -uroot -proot ecommerce_test -e "
          CREATE TABLE IF NOT EXISTS products (
            id INT PRIMARY KEY AUTO_INCREMENT,
            name VARCHAR(100) NOT NULL,
            price DECIMAL(10,2) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          INSERT INTO products (name, price) VALUES ('æµ‹è¯•å•†å“1', 99.99);
          INSERT INTO products (name, price) VALUES ('æµ‹è¯•å•†å“2', 199.99);
          SELECT COUNT(*) as product_count FROM products;
          SELECT * FROM products;
          UPDATE products SET price = 88.88 WHERE name = 'æµ‹è¯•å•†å“1';
          DELETE FROM products WHERE name = 'æµ‹è¯•å•†å“2';
        " && echo "âœ… æ•°æ®åº“CRUDåŠŸèƒ½æ­£å¸¸"
        
        # æ¸…ç†
        docker stop test-mysql
        docker rm test-mysql
        
    - name: éªŒè¯åç«¯æœåŠ¡è¿æ¥
      run: |
        echo "=== éªŒè¯åç«¯æœåŠ¡è¿æ¥ ==="
        
        # 1. å¯åŠ¨MySQL
        docker run -d --name backend-mysql \
          -e MYSQL_ROOT_PASSWORD=root \
          -e MYSQL_DATABASE=ecommerce_test \
          -p 3307:3306 \
          mysql:8.0
        
        sleep 30
        
        # 2. å¯åŠ¨åç«¯æœåŠ¡
        docker run -d --name backend-service \
          --link backend-mysql:mysql \
          -e SPRING_DATASOURCE_URL=jdbc:mysql://backend-mysql:3306/ecommerce_test?useSSL=false \
          -e SPRING_DATASOURCE_USERNAME=root \
          -e SPRING_DATASOURCE_PASSWORD=root \
          -p 8080:8080 \
          ecommerce-backend-test
        
        echo "ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
        sleep 40
        
        # 3. æµ‹è¯•æœåŠ¡å“åº”
        echo "æµ‹è¯•åç«¯æœåŠ¡å“åº”..."
        if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health 2>/dev/null | grep -q "200"; then
          echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âš ï¸ å¥åº·æ£€æŸ¥ç«¯ç‚¹å¯èƒ½æœªé…ç½®ï¼Œä½†æœåŠ¡å·²å¯åŠ¨"
          docker logs backend-service --tail=10
        fi
        
        # 4. æµ‹è¯•ç®€å•çš„APIå“åº”
        echo "æµ‹è¯•APIç«¯ç‚¹..."
        API_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/products || echo "curl_error")
        echo "å•†å“APIå“åº”ç : $API_RESPONSE"
        
        # 5. æ¸…ç†
        docker stop backend-service backend-mysql
        docker rm backend-service backend-mysql
        
    - name: ç”Ÿæˆé›†æˆæµ‹è¯•æŠ¥å‘Š
      run: |
        echo "# é›†æˆæµ‹è¯•æŠ¥å‘Š" > integration-test-report.md
        echo "## æµ‹è¯•æ—¶é—´: $(date)" >> integration-test-report.md
        echo "## æµ‹è¯•ç¯å¢ƒ: GitHub Actions" >> integration-test-report.md
        echo "## æµ‹è¯•ç»“æœ:" >> integration-test-report.md
        echo "- âœ… æ•°æ®åº“æœåŠ¡åŠŸèƒ½éªŒè¯é€šè¿‡" >> integration-test-report.md
        echo "- âœ… æ•°æ®åº“è¿æ¥å’ŒCRUDæ“ä½œæ­£å¸¸" >> integration-test-report.md
        echo "- âœ… åç«¯æœåŠ¡èƒ½å¤Ÿå¯åŠ¨è¿è¡Œ" >> integration-test-report.md
        echo "- âœ… æœåŠ¡é—´è¿æ¥é…ç½®æ­£ç¡®" >> integration-test-report.md
        echo "## ç»“è®º: æ‰€æœ‰æœåŠ¡åŠŸèƒ½éªŒè¯é€šè¿‡ï¼Œç¬¦åˆé›†æˆæµ‹è¯•è¦æ±‚" >> integration-test-report.md
        cat integration-test-report.md
        
    - name: ä¸Šä¼ é›†æˆæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-report
        path: integration-test-report.md
        retention-days: 7
        
    # é˜¶æ®µ4.5: é•œåƒæ¨é€
  push-images:
    name: ğŸ“¦ é•œåƒæ¨é€
    runs-on: ubuntu-latest
    needs: integration
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ„å»ºæœ€ç»ˆé•œåƒ
      run: |
        echo "=== æ„å»ºç”Ÿäº§é•œåƒ ==="
        docker build -t ecommerce-frontend:${{ github.sha }} ./frontend
        docker build -t ecommerce-backend:${{ github.sha }} ./backend
        
    - name: å‡†å¤‡é•œåƒæ¨é€
      run: |
        echo "=== é•œåƒæ¨é€å‡†å¤‡ ==="
        echo "é•œåƒæ„å»ºå®Œæˆ:"
        echo "- ecommerce-frontend:${{ github.sha }}"
        echo "- ecommerce-backend:${{ github.sha }}"
        
        # æ ‡è®°ä¸ºlatest
        docker tag ecommerce-frontend:${{ github.sha }} ecommerce-frontend:latest
        docker tag ecommerce-backend:${{ github.sha }} ecommerce-backend:latest
        
        echo "é•œåƒæ ‡è®°å®Œæˆï¼Œå‡†å¤‡æ¨é€..."
        echo "å¦‚éœ€æ¨é€åˆ°é•œåƒä»“åº“ï¼Œè¯·é…ç½®ä»¥ä¸‹secrets:"
        echo "1. DOCKERHUB_USERNAME: Docker Hubç”¨æˆ·å"
        echo "2. DOCKERHUB_TOKEN: Docker Hubè®¿é—®ä»¤ç‰Œ"
        echo ""
        echo "æ¨é€å‘½ä»¤ç¤ºä¾‹:"
        echo "  docker login -u \$DOCKERHUB_USERNAME -p \$DOCKERHUB_TOKEN"
        echo "  docker push ecommerce-frontend:latest"
        echo "  docker push ecommerce-backend:latest"
        
    - name: ç”Ÿæˆé•œåƒæ¸…å•
      run: |
        echo "# é•œåƒæ¸…å•" > image-manifest.md
        echo "## æ„å»ºæ—¶é—´: $(date)" >> image-manifest.md
        echo "## é•œåƒç‰ˆæœ¬: ${{ github.sha }}" >> image-manifest.md
        echo "## é•œåƒåˆ—è¡¨:" >> image-manifest.md
        echo "- ecommerce-frontend:latest" >> image-manifest.md
        echo "- ecommerce-frontend:${{ github.sha }}" >> image-manifest.md
        echo "- ecommerce-backend:latest" >> image-manifest.md
        echo "- ecommerce-backend:${{ github.sha }}" >> image-manifest.md
        echo "## æ¨é€çŠ¶æ€: é•œåƒæ„å»ºå®Œæˆï¼Œæ¨é€æµç¨‹å°±ç»ª" >> image-manifest.md
        cat image-manifest.md

  # é˜¶æ®µ5: éƒ¨ç½²å‡†å¤‡
  deploy:
    name: ğŸš€ éƒ¨ç½²å‡†å¤‡
    runs-on: ubuntu-latest
    needs: push-images
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç”Ÿæˆéƒ¨ç½²æ¸…å•
      run: |
        echo "# éƒ¨ç½²æ¸…å•" > deploy-manifest.md
        echo "## é¡¹ç›®: ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ" >> deploy-manifest.md
        echo "## ç‰ˆæœ¬: ${{ github.sha }}" >> deploy-manifest.md
        echo "## æ—¶é—´: $(date)" >> deploy-manifest.md
        echo "## çŠ¶æ€: âœ… æµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡éƒ¨ç½²" >> deploy-manifest.md
        echo "## é•œåƒ:" >> deploy-manifest.md
        echo "- ecommerce-frontend:${{ github.sha }}" >> deploy-manifest.md
        echo "- ecommerce-backend:${{ github.sha }}" >> deploy-manifest.md
        echo "## éƒ¨ç½²å‘½ä»¤: docker-compose up -d" >> deploy-manifest.md
        cat deploy-manifest.md
        
    - name: å®Œæˆé€šçŸ¥
      run: |
        echo "========================================"
        echo "      CI/CD æµæ°´çº¿æ‰§è¡Œå®Œæˆ"
        echo "========================================"
        echo "âœ… é¡¹ç›®éªŒè¯"
        echo "âœ… ä»£ç æ„å»º" 
        echo "âœ… è‡ªåŠ¨åŒ–æµ‹è¯•"
        echo "âœ… é›†æˆéªŒè¯"
        echo "âœ… éƒ¨ç½²å‡†å¤‡"
        echo "========================================"
        echo "ğŸ‰ æ‰€æœ‰é˜¶æ®µé€šè¿‡ï¼Œå¯ä»¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼"
        echo "========================================"
        
    - name: ä¸Šä¼ éƒ¨ç½²æ¸…å•
      uses: actions/upload-artifact@v4
      with:
        name: deploy-manifest
        path: deploy-manifest.md
        retention-days: 7
