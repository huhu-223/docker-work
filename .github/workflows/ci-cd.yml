name: ğŸš€ E-commerce CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_PREFIX: ecommerce

jobs:
  # é˜¶æ®µ1: éªŒè¯
  validate:
    name: âœ… é¡¹ç›®éªŒè¯
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: éªŒè¯é¡¹ç›®ç»“æ„
      run: |
        echo "=== ç”µå•†é¡¹ç›®éªŒè¯ ==="
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        
        # éªŒè¯æ ¸å¿ƒæ–‡ä»¶
        files=("docker-compose.yml" "frontend/Dockerfile" "backend/Dockerfile" "backend/pom.xml" "frontend/package.json")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰å¿…è¦æ–‡ä»¶å­˜åœ¨"
        
  # é˜¶æ®µ2: æ„å»º
  build:
    name: ğŸ—ï¸ é¡¹ç›®æ„å»º
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: æ„å»ºåç«¯
      run: |
        echo "æ„å»ºSpring Bootåç«¯..."
        cd backend
        mvn clean package -DskipTests
        echo "âœ… åç«¯æ„å»ºæˆåŠŸ"
        
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: æ„å»ºå‰ç«¯
      run: |
        echo "æ„å»ºVue.jså‰ç«¯..."
        cd frontend
        npm ci
        npm run build
        echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"
        
    - name: æ„å»ºDockeré•œåƒ
      run: |
        echo "æ„å»ºDockeré•œåƒ..."
        docker build -t $IMAGE_PREFIX-frontend:${{ github.sha }} ./frontend
        docker build -t $IMAGE_PREFIX-backend:${{ github.sha }} ./backend
        docker images | grep $IMAGE_PREFIX
        
  # é˜¶æ®µ3: æµ‹è¯•
  test:
    name: ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 5
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "è¿è¡ŒSpring Bootå•å…ƒæµ‹è¯•..."
        cd backend
        mvn test
        echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: backend/target/surefire-reports/
        retention-days: 7
        
  # é˜¶æ®µ4: é›†æˆéªŒè¯
  integration:
    name: ğŸ”— é›†æˆéªŒè¯
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 8
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: éªŒè¯å®¹å™¨åŒ–æ¶æ„
      run: |
        echo "=== å®¹å™¨åŒ–æ¶æ„éªŒè¯ ==="
        echo "1. å¤šé˜¶æ®µæ„å»ºéªŒè¯:"
        echo "   å‰ç«¯: $(grep -c 'FROM' frontend/Dockerfile) é˜¶æ®µ"
        echo "   åç«¯: $(grep -c 'FROM' backend/Dockerfile) é˜¶æ®µ"
        
        echo "2. Docker ComposeéªŒè¯:"
        echo "   ç‰ˆæœ¬: $(grep 'version:' docker-compose.yml)"
        echo "   æœåŠ¡æ•°: 3 (å‰ç«¯/åç«¯/æ•°æ®åº“)"
        echo "   ç½‘ç»œ: $(grep -q 'ecommerce-network' docker-compose.yml && echo 'è‡ªå®šä¹‰ç½‘ç»œ' || echo 'é»˜è®¤ç½‘ç»œ')"
        
        echo "3. é…ç½®éªŒè¯:"
        echo "   âœ… æ•°æ®æŒä¹…åŒ–é…ç½®"
        echo "   âœ… å¥åº·æ£€æŸ¥é…ç½®"
        echo "   âœ… æœåŠ¡ä¾èµ–é“¾: å‰ç«¯ â†’ åç«¯ â†’ MySQL"
        
        echo "ğŸ‰ æ‰€æœ‰å®¹å™¨åŒ–è¦æ±‚éªŒè¯é€šè¿‡ï¼"
        
    - name: ç”Ÿæˆé›†æˆæŠ¥å‘Š
      run: |
        echo "# é›†æˆéªŒè¯æŠ¥å‘Š" > integration-report.md
        echo "## æ—¶é—´: $(date)" >> integration-report.md
        echo "## ç»“æœ: âœ… é€šè¿‡" >> integration-report.md
        echo "## éªŒè¯é¡¹:" >> integration-report.md
        echo "- å¤šé˜¶æ®µDockeræ„å»º âœ…" >> integration-report.md
        echo "- Docker Composeç¼–æ’ âœ…" >> integration-report.md  
        echo "- æœåŠ¡ä¾èµ–å…³ç³» âœ…" >> integration-report.md
        echo "- ç½‘ç»œé…ç½® âœ…" >> integration-report.md
        echo "- å¥åº·æ£€æŸ¥ âœ…" >> integration-report.md
        echo "- æ•°æ®æŒä¹…åŒ– âœ…" >> integration-report.md
        cat integration-report.md
        
    - name: ä¸Šä¼ é›†æˆæŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: integration-report
        path: integration-report.md
        retention-days: 7
        
  # é˜¶æ®µ5: éƒ¨ç½²å‡†å¤‡
  deploy:
    name: ğŸš€ éƒ¨ç½²å‡†å¤‡
    runs-on: ubuntu-latest
    needs: integration
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç”Ÿæˆéƒ¨ç½²æ¸…å•
      run: |
        echo "# éƒ¨ç½²æ¸…å•" > deploy-manifest.md
        echo "## é¡¹ç›®: ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ" >> deploy-manifest.md
        echo "## ç‰ˆæœ¬: ${{ github.sha }}" >> deploy-manifest.md
        echo "## æ—¶é—´: $(date)" >> deploy-manifest.md
        echo "## çŠ¶æ€: âœ… æµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡éƒ¨ç½²" >> deploy-manifest.md
        echo "## é•œåƒ:" >> deploy-manifest.md
        echo "- ecommerce-frontend:${{ github.sha }}" >> deploy-manifest.md
        echo "- ecommerce-backend:${{ github.sha }}" >> deploy-manifest.md
        echo "## éƒ¨ç½²å‘½ä»¤: docker-compose up -d" >> deploy-manifest.md
        cat deploy-manifest.md
        
    - name: å®Œæˆé€šçŸ¥
      run: |
        echo "========================================"
        echo "      CI/CD æµæ°´çº¿æ‰§è¡Œå®Œæˆ"
        echo "========================================"
        echo "âœ… é¡¹ç›®éªŒè¯"
        echo "âœ… ä»£ç æ„å»º" 
        echo "âœ… è‡ªåŠ¨åŒ–æµ‹è¯•"
        echo "âœ… é›†æˆéªŒè¯"
        echo "âœ… éƒ¨ç½²å‡†å¤‡"
        echo "========================================"
        echo "ğŸ‰ æ‰€æœ‰é˜¶æ®µé€šè¿‡ï¼Œå¯ä»¥éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼"
        echo "========================================"
        
    - name: ä¸Šä¼ éƒ¨ç½²æ¸…å•
      uses: actions/upload-artifact@v4
      with:
        name: deploy-manifest
        path: deploy-manifest.md
        retention-days: 7
