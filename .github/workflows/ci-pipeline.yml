name: ðŸš€ E-commerce CI/CD Pipeline

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# å·¥ä½œæµç¨‹
jobs:
  # é˜¶æ®µ1: ä»£ç éªŒè¯
  validate:
    name: âœ… éªŒè¯é¡¹ç›®ç»“æž„
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
      run: |
        echo "========================================"
        echo "     ç”µå•†é¡¹ç›® CI/CD æµæ°´çº¿"
        echo "========================================"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "è§¦å‘è€…: ${{ github.actor }}"
        echo "========================================"
        
    - name: æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥é¡¹ç›®æ–‡ä»¶..."
        echo "1. docker-compose.yml: $(if [ -f "docker-compose.yml" ]; then echo "âœ… å­˜åœ¨"; else echo "âŒ ä¸å­˜åœ¨"; fi)"
        echo "2. frontend/Dockerfile: $(if [ -f "frontend/Dockerfile" ]; then echo "âœ… å­˜åœ¨"; else echo "âŒ ä¸å­˜åœ¨"; fi)"
        echo "3. backend/Dockerfile: $(if [ -f "backend/Dockerfile" ]; then echo "âœ… å­˜åœ¨"; else echo "âŒ ä¸å­˜åœ¨"; fi)"
        echo "4. backend/pom.xml: $(if [ -f "backend/pom.xml" ]; then echo "âœ… å­˜åœ¨"; else echo "âŒ ä¸å­˜åœ¨"; fi)"
        echo "5. frontend/package.json: $(if [ -f "frontend/package.json" ]; then echo "âœ… å­˜åœ¨"; else echo "âŒ ä¸å­˜åœ¨"; fi)"
        
    - name: æ˜¾ç¤ºç›®å½•ç»“æž„
      run: |
        echo "é¡¹ç›®ç»“æž„:"
        ls -la
        echo ""
        echo "å‰ç«¯ç›®å½•:"
        ls -la frontend/
        echo ""
        echo "åŽç«¯ç›®å½•:"
        ls -la backend/
        
  # é˜¶æ®µ2: æž„å»º
  build:
    name: ðŸ—ï¸ æž„å»ºé¡¹ç›®
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®JavaçŽ¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: æž„å»ºåŽç«¯åº”ç”¨
      run: |
        echo "å¼€å§‹æž„å»ºåŽç«¯..."
        cd backend
        mvn clean compile -DskipTests
        echo "âœ… åŽç«¯ç¼–è¯‘æˆåŠŸ"
        
    - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: æž„å»ºå‰ç«¯åº”ç”¨
      run: |
        echo "å¼€å§‹æž„å»ºå‰ç«¯..."
        cd frontend
        npm ci
        npm run build
        echo "âœ… å‰ç«¯æž„å»ºæˆåŠŸ"
        
    - name: æž„å»ºDockeré•œåƒ
      run: |
        echo "æž„å»ºDockeré•œåƒ..."
        echo "1. æž„å»ºå‰ç«¯é•œåƒ:"
        cd frontend
        docker build -t frontend:${{ github.sha }} .
        
        echo "2. æž„å»ºåŽç«¯é•œåƒ:"
        cd ../backend
        docker build -t backend:${{ github.sha }} .
        
        echo "3. é•œåƒåˆ—è¡¨:"
        docker images | grep -E "frontend|backend"
        
  # é˜¶æ®µ3: æµ‹è¯•
  test:
    name: ðŸ§ª è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡ŒåŽç«¯æµ‹è¯•
      run: |
        echo "è¿è¡ŒåŽç«¯æµ‹è¯•..."
        cd backend
        mvn test
        echo "âœ… æµ‹è¯•å®Œæˆ"
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          backend/target/surefire-reports/
        retention-days: 7
        
  # é˜¶æ®µ4: é›†æˆæµ‹è¯•
  integration:
    name: ðŸ”— é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: test
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: ecommerce_database
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç­‰å¾…MySQLå¯åŠ¨
      run: |
        echo "ç­‰å¾…MySQLæ•°æ®åº“å¯åŠ¨..."
        sleep 30
        
    - name: å¯åŠ¨æœåŠ¡æµ‹è¯•
      run: |
        echo "å¯åŠ¨æœåŠ¡è¿›è¡Œé›†æˆæµ‹è¯•..."
        docker-compose up -d
        sleep 40
        
        echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
        docker-compose ps
        
        echo "æµ‹è¯•åŽç«¯å¥åº·:"
        curl -f http://localhost:8081/actuator/health || echo "å¥åº·æ£€æŸ¥ç«¯ç‚¹å¯èƒ½ä¸å­˜åœ¨"
        
        echo "æµ‹è¯•å‰ç«¯:"
        curl -f http://localhost:80 || echo "å‰ç«¯å¯èƒ½æœªé…ç½®"
        
    - name: åœæ­¢æœåŠ¡
      if: always()
      run: |
        docker-compose down
        
  # é˜¶æ®µ5: éƒ¨ç½²é€šçŸ¥
  notify:
    name: ðŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: integration
    if: success()
    
    steps:
    - name: æˆåŠŸé€šçŸ¥
      run: |
        echo "ðŸŽ‰ ðŸŽ‰ ðŸŽ‰ CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
        echo "========================================"
        echo "æ‰€æœ‰é˜¶æ®µéƒ½é€šè¿‡äº†:"
        echo "1. âœ… é¡¹ç›®éªŒè¯"
        echo "2. âœ… ä»£ç æž„å»º"
        echo "3. âœ… å•å…ƒæµ‹è¯•"
        echo "4. âœ… é›†æˆæµ‹è¯•"
        echo "========================================"
        echo "å¯ä»¥å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒäº†"
        
    - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "# éƒ¨ç½²æŠ¥å‘Š" > report.md
        echo "## é¡¹ç›®: ${{ github.repository }}" >> report.md
        echo "## åˆ†æ”¯: ${{ github.ref }}" >> report.md
        echo "## æäº¤: ${{ github.sha }}" >> report.md
        echo "## æ—¶é—´: $(date)" >> report.md
        echo "## çŠ¶æ€: âœ… å…¨éƒ¨é€šè¿‡" >> report.md
        echo "## ä¸‹ä¸€æ­¥: å¯ä»¥éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ" >> report.md
        cat report.md
